#!/usr/bin/env python2.7

import sys
import os
from subprocess import Popen, PIPE, call

def escapeForJavaScript(string):
    # Need to escape quotes and newlines for JavaScript
    return string.replace('"', '\\x22').replace('\n', '\\x0A')

def checkRscriptDependencies():
    for dep in ['kinship2', 'jsonlite']:
        proc = Popen(['@RSCRIPT_COMMAND@', '-'], stdout=PIPE, stdin=PIPE,
                     stderr=PIPE)
        proc.communicate(input="library({})".format(dep))

        if proc.returncode != 0:
            print("mutmap requires {} library for R. Please install".format(dep))
            exit(1)


if __name__ == '__main__':
    if len(sys.argv) != 4:
        print("mutmap requires 3 arguments")
        sys.exit(1)

    checkRscriptDependencies()

    pedFilename = sys.argv[1]
    with open(pedFilename, 'r') as pedFile:
        pedFileData = pedFile.read()

    dngOutputFilePath = sys.argv[2]
    with open(dngOutputFilePath, 'r') as dngOutputFile:
        dngOutputData = escapeForJavaScript(dngOutputFile.read())

    templateFilePath = os.path.join('@MUTMAP_DIR@', 'index.html')
    with open(templateFilePath, 'r') as templateFile:
        templateFileData = templateFile.read()

    layoutScriptPath = os.path.join('@MUTMAP_DIR@', 'pedigree_and_layout.R')
    rProc = Popen(['@RSCRIPT_COMMAND@', layoutScriptPath], stdout=PIPE,
                  stdin=PIPE, stderr=PIPE)
    layoutData = rProc.communicate(input=pedFileData)[0]

    outFileData = templateFileData

    pedFileData = escapeForJavaScript(pedFileData)
    outFileData = outFileData.replace(
        '/*PEDIGREE_FILE_TEXT_PLACEHOLDER*/',
        "var pedigreeFileText = \"" + pedFileData + "\";")
    outFileData = outFileData.replace(
        '/*LAYOUT_DATA_PLACEHOLDER*/',
        "var layoutData = " + layoutData + ";")
    outFileData = outFileData.replace(
        '/*DNG_VCF_DATA_PLACEHOLDER*/',
        "var dngOutputFileText = \"" + dngOutputData + "\";")

    outFileName = sys.argv[3]
    with open(outFileName, 'w') as outFile:
        outFile.write(outFileData)
